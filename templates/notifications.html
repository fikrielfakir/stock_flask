{% extends "base.html" %}

{% block title %}Notifications - StockCeramique{% endblock %}

{% block content %}
<div>
    <!-- Page Header -->
    <div class="glass-card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col md:flex-row md:items-center justify-between">
            <div>
                <h1 class="text-responsive-xl font-bold text-gray-900 mb-2">Notifications</h1>
                <p class="text-gray-600 text-lg">Alertes et notifications en temps réel</p>
            </div>
            <div class="mt-4 md:mt-0 flex space-x-3">
                <button onclick="refreshNotifications()" class="btn-secondary px-6 py-3 rounded-lg touch-target flex items-center space-x-2">
                    <i class="fas fa-refresh"></i>
                    <span>Actualiser</span>
                </button>
                <button onclick="markAllAsRead()" class="btn-primary px-6 py-3 rounded-lg touch-target flex items-center space-x-2">
                    <i class="fas fa-check"></i>
                    <span>Tout marquer lu</span>
                </button>
            </div>
        </div>
    </div>

    <div class="px-6">
        <!-- Notifications List -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 mb-6">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Notifications système</h3>
                    <span id="notification-count" class="text-white text-xs px-2 py-1 rounded-full" style="background-color: var(--primary-color);">0</span>
                </div>
            </div>
            <div id="notifications-container" class="divide-y divide-gray-100">
                <!-- Notifications will be loaded here -->
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-gray-50 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-bell text-gray-400 text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Chargement...</h4>
                    <p class="text-gray-600">Récupération des notifications en cours</p>
                </div>
            </div>
        </div>

        <!-- Activity Logs Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Activités récentes</h3>
                    <button onclick="loadActivities()" class="text-xs hover:opacity-80" style="color: var(--primary-color);">
                        <i class="fas fa-refresh mr-1"></i>Actualiser
                    </button>
                </div>
            </div>
            <div id="activities-container" class="divide-y divide-gray-100">
                <!-- Activities will be loaded here -->
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-blue-50 rounded-full mx-auto mb-3 flex items-center justify-center">
                        <i class="fas fa-history text-blue-500 text-lg"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900 mb-1">Chargement des activités...</h4>
                    <p class="text-xs text-gray-600">Récupération en cours</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let notificationRefreshInterval;
    
    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadNotifications();
        loadActivities();
        // Start real-time updates every 30 seconds
        notificationRefreshInterval = setInterval(() => {
            loadNotifications();
            loadActivities();
        }, 30000);
    });

    // Clean up interval when leaving page
    window.addEventListener('beforeunload', function() {
        if (notificationRefreshInterval) {
            clearInterval(notificationRefreshInterval);
        }
    });

    async function loadNotifications() {
        try {
            const response = await apiRequest('GET', '/api/notifications');
            displayNotifications(response.notifications);
            updateNotificationCount(response.count);
        } catch (error) {
            console.error('Error loading notifications:', error);
            showError('Erreur lors du chargement des notifications');
        }
    }

    function displayNotifications(notifications) {
        const container = document.getElementById('notifications-container');
        
        if (!notifications || notifications.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-16 h-16 bg-green-50 rounded-full mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Aucune notification</h4>
                    <p class="text-gray-600">Tout est à jour !</p>
                </div>
            `;
            return;
        }

        container.innerHTML = notifications.map(notification => `
            <div class="p-4 hover:bg-gray-50 transition-colors duration-200 notification-item" data-id="${notification.id}">
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center" 
                             style="background-color: ${getNotificationBgColor(notification.color)};">
                            <i class="${notification.icon} text-${notification.color}-600"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-gray-900">${notification.title}</p>
                            <p class="text-xs text-gray-500">${notification.time}</p>
                        </div>
                        <p class="text-sm text-gray-700 mt-1">${notification.message}</p>
                        <div class="flex items-center mt-2 space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getNotificationTypeClass(notification.type)}"
                                  ${notification.type === 'info' ? 'style="background-color: rgba(0, 61, 157, 0.1); color: var(--primary-color);"' : ''}>
                                ${getNotificationTypeLabel(notification.type)}
                            </span>
                            ${getNotificationActions(notification)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function getNotificationBgColor(color) {
        const colorMap = {
            'red': '#FEF2F2',
            'blue': '#EFF6FF',
            'green': '#F0FDF4',
            'yellow': '#FFFBEB',
            'gray': '#F9FAFB'
        };
        return colorMap[color] || '#F9FAFB';
    }

    function getNotificationTypeClass(type) {
        const typeMap = {
            'warning': 'bg-red-100 text-red-800',
            'info': 'text-white',  // Will use inline style for background
            'success': 'bg-green-100 text-green-800',
            'error': 'bg-red-100 text-red-800'
        };
        return typeMap[type] || 'bg-gray-100 text-gray-800';
    }

    function getNotificationTypeLabel(type) {
        const labelMap = {
            'warning': 'Alerte',
            'info': 'Information',
            'success': 'Succès',
            'error': 'Erreur'
        };
        return labelMap[type] || 'Notification';
    }

    function getNotificationActions(notification) {
        let actions = '';
        
        if (notification.id === 'low_stock') {
            actions += `<button onclick="viewLowStock()" class="text-xs hover:opacity-80" style="color: var(--primary-color);">Voir détails</button>`;
        } else if (notification.id === 'pending_requests') {
            actions += `<button onclick="viewPendingRequests()" class="text-xs hover:opacity-80" style="color: var(--primary-color);">Voir demandes</button>`;
        } else if (notification.id === 'recent_receptions') {
            actions += `<button onclick="viewReceptions()" class="text-xs hover:opacity-80" style="color: var(--primary-color);">Voir réceptions</button>`;
        }
        
        return actions;
    }

    function updateNotificationCount(count) {
        const countElement = document.getElementById('notification-count');
        if (countElement) {
            countElement.textContent = count;
            countElement.className = count > 0 
                ? 'bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full'
                : 'text-white text-xs px-2 py-1 rounded-full';
            if (count === 0) {
                countElement.style.backgroundColor = 'var(--primary-color)';
            }
        }
    }

    function refreshNotifications() {
        loadNotifications();
        showSuccess('Notifications actualisées');
    }

    function markAllAsRead() {
        // For now, just refresh the notifications
        // In a real implementation, you'd call an API to mark as read
        loadNotifications();
        showSuccess('Toutes les notifications ont été marquées comme lues');
    }

    // Action handlers
    function viewLowStock() {
        window.location.href = '/stock-status';
    }

    function viewPendingRequests() {
        window.location.href = '/purchase-requests';
    }

    function viewReceptions() {
        window.location.href = '/reception';
    }

    function showSuccess(message) {
        // Simple success notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function showError(message) {
        // Simple error notification
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Activity logs functions
    async function loadActivities() {
        try {
            const response = await apiRequest('GET', '/api/activity-logs?limit=10');
            displayActivities(response.logs);
        } catch (error) {
            console.error('Error loading activities:', error);
            showActivityError();
        }
    }

    function displayActivities(activities) {
        const container = document.getElementById('activities-container');
        
        if (!activities || activities.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gray-50 rounded-full mx-auto mb-3 flex items-center justify-center">
                        <i class="fas fa-history text-gray-400 text-lg"></i>
                    </div>
                    <h4 class="text-sm font-medium text-gray-900 mb-1">Aucune activité</h4>
                    <p class="text-xs text-gray-600">Les activités récentes apparaîtront ici</p>
                </div>
            `;
            return;
        }

        container.innerHTML = activities.map(activity => {
            const timeAgo = formatTimeAgo(activity.createdAt);
            const icon = getActivityIcon(activity.action);
            const color = getActivityColor(activity.action);
            
            return `
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center bg-${color}-100">
                                <i class="${icon} text-${color}-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-gray-900">${getActionDescription(activity.action)}</p>
                                <p class="text-xs text-gray-500">${timeAgo}</p>
                            </div>
                            <p class="text-sm text-gray-700 mt-1">${activity.entityName || getEntityTypeLabel(activity.entityType)}</p>
                            <p class="text-xs text-gray-500 mt-1">${getEntityTypeLabel(activity.entityType)}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function getActivityIcon(action) {
        const iconMap = {
            'CREATE': 'fas fa-plus-circle',
            'UPDATE': 'fas fa-edit',
            'DELETE': 'fas fa-trash',
            'EXPORT': 'fas fa-download',
            'IMPORT': 'fas fa-upload'
        };
        return iconMap[action] || 'fas fa-info-circle';
    }

    function getActivityColor(action) {
        const colorMap = {
            'CREATE': 'green',
            'UPDATE': 'blue',
            'DELETE': 'red',
            'EXPORT': 'purple',
            'IMPORT': 'indigo'
        };
        return colorMap[action] || 'gray';
    }

    function getActionDescription(action) {
        const descMap = {
            'CREATE': 'Ajout',
            'UPDATE': 'Modification',
            'DELETE': 'Suppression',
            'EXPORT': 'Export',
            'IMPORT': 'Import'
        };
        return descMap[action] || action;
    }

    function getEntityTypeLabel(entityType) {
        const labelMap = {
            'suppliers': 'Fournisseur',
            'requestors': 'Demandeur',
            'articles': 'Article',
            'purchase_requests': 'Demande d\'achat',
            'receptions': 'Réception',
            'outbounds': 'Sortie'
        };
        return labelMap[entityType] || entityType;
    }

    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Il y a quelques secondes';
        } else if (diffInSeconds < 3600) {
            const minutes = Math.floor(diffInSeconds / 60);
            return `Il y a ${minutes} minute${minutes > 1 ? 's' : ''}`;
        } else if (diffInSeconds < 86400) {
            const hours = Math.floor(diffInSeconds / 3600);
            return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
        } else {
            const days = Math.floor(diffInSeconds / 86400);
            return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
        }
    }

    function showActivityError() {
        const container = document.getElementById('activities-container');
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="w-12 h-12 bg-red-50 rounded-full mx-auto mb-3 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-lg"></i>
                </div>
                <h4 class="text-sm font-medium text-gray-900 mb-1">Erreur de chargement</h4>
                <p class="text-xs text-gray-600">Impossible de charger les activités</p>
            </div>
        `;
    }
</script>
{% endblock %}