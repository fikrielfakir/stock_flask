<!doctype html>
<html lang="fr" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Activation - StockCeramique</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <style>
            :root {
                --primary-color: #003d9d;
                --primary-light: #1a4fb3;
                --primary-dark: #002875;
                --error-color: #ef4444;
                --success-color: #10b981;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            }

            .glass-card {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }

            .btn-primary {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
                transition: all 0.3s ease;
            }

            .btn-primary:hover {
                background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 61, 157, 0.3);
            }

            .security-icon {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
        </style>
    </head>
    <body class="h-full bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
        <div class="min-h-screen flex items-center justify-center p-6">
            <div class="glass-card rounded-2xl p-8 w-full max-w-md">
                <!-- Security Icon -->
                <div class="text-center mb-6">
                    <div class="security-icon inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full text-white mb-4">
                        <i class="fas fa-shield-alt text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">Activation Required</h1>
                    <p class="text-gray-600">This software requires activation to continue</p>
                </div>

                <!-- Machine Info -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-700 mb-2">Machine Information:</h3>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div><strong>Machine:</strong> <span id="machine-name">{{ machine_name }}</span></div>
                        <div><strong>Identifier:</strong> <span id="machine-id" class="font-mono">{{ machine_id }}</span></div>
                    </div>
                </div>

                <!-- Activation Form -->
                <form id="activation-form" class="space-y-4">
                    <div>
                        <label for="license-key" class="block text-sm font-medium text-gray-700 mb-2">
                            License Key
                        </label>
                        <input
                            type="text"
                            id="license-key"
                            name="license_key"
                            placeholder="XXXX-XXXX-XXXX-XXXX"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-center text-lg tracking-wider"
                            maxlength="19"
                            pattern="[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}"
                            required
                        />
                    </div>

                    <!-- Error Message -->
                    <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="error-text"></span>
                    </div>

                    <!-- Success Message -->
                    <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span id="success-text"></span>
                    </div>

                    <!-- Buttons -->
                    <div class="space-y-3">
                        <button
                            type="submit"
                            class="btn-primary w-full text-white font-semibold py-3 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            id="activate-btn"
                        >
                            <i class="fas fa-key mr-2"></i>
                            Activate License
                        </button>

                        <button
                            type="button"
                            onclick="generateLicenseKey()"
                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors"
                        >
                            <i class="fas fa-cog mr-2"></i>
                            Generate License Key for This Machine
                        </button>
                    </div>
                </form>

                <!-- Info Section -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        License Information
                    </h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• One license per computer/device</li>
                        <li>• License is tied to your machine's hardware</li>
                        <li>• Contact support for license transfer</li>
                    </ul>
                </div>
            </div>
        </div>

        <script>
            // Format license key input
            document.getElementById('license-key').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^A-Z0-9]/g, '').toUpperCase();
                let formatted = '';
                
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) {
                        formatted += '-';
                    }
                    formatted += value[i];
                }
                
                e.target.value = formatted;
            });

            // Handle form submission
            document.getElementById('activation-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const licenseKey = document.getElementById('license-key').value;
                const activateBtn = document.getElementById('activate-btn');
                const errorDiv = document.getElementById('error-message');
                const successDiv = document.getElementById('success-message');
                
                // Reset messages
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                
                // Disable button and show loading
                activateBtn.disabled = true;
                activateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Activating...';
                
                try {
                    const response = await fetch('/api/activate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ license_key: licenseKey })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        // Success
                        document.getElementById('success-text').textContent = result.message;
                        successDiv.classList.remove('hidden');
                        
                        // Redirect to dashboard after 2 seconds
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else {
                        // Error
                        document.getElementById('error-text').textContent = result.message || 'Activation failed';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    document.getElementById('error-text').textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    // Re-enable button
                    activateBtn.disabled = false;
                    activateBtn.innerHTML = '<i class="fas fa-key mr-2"></i>Activate License';
                }
            });

            // Generate license key for current machine
            async function generateLicenseKey() {
                try {
                    const response = await fetch('/api/generate-license');
                    const result = await response.json();
                    
                    if (result.success) {
                        // Auto-fill the license key
                        document.getElementById('license-key').value = result.license_key;
                        
                        // Show info message
                        alert(`License Key Generated: ${result.license_key}\n\nThis key is specifically for your machine: ${result.machine_id}`);
                    } else {
                        alert('Error generating license key: ' + result.message);
                    }
                } catch (error) {
                    alert('Error generating license key. Please try again.');
                }
            }
        </script>
    </body>
</html>