{% extends "base.html" %}

{% block title %}Tableau de Bord - StockCeramique{% endblock %}

{% block content %}
<div>
    <!-- Page Header -->
    <div class="glass-card rounded-2xl p-8 mb-8 fade-in">
        <div class="flex flex-col md:flex-row md:items-center justify-between">
            <div>
                <h1 class="text-responsive-xl font-bold text-gray-900 mb-2">Tableau de Bord</h1>
                <p class="text-gray-600 text-lg">Vue d'ensemble de votre système de gestion de stock</p>
            </div>
            <div class="mt-4 md:mt-0 flex space-x-3">
                <button onclick="createNewRequest()" class="btn-primary px-6 py-3 rounded-lg touch-target flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Nouvelle Demande</span>
                </button>
                <button onclick="generateReport()" class="btn-secondary px-6 py-3 rounded-lg touch-target flex items-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Rapport</span>
                </button>
            </div>
        </div>
    </div>

    <div class="px-6">
        <!-- Stats Cards -->
        <div class="grid-responsive mb-8" id="stats-cards">
            <!-- Initial empty state -->
            <div class="glass-card card-hover rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Articles</p>
                        <p class="text-3xl font-bold" style="color: var(--primary-color);">0</p>
                        <p class="text-sm mt-1" style="color: var(--primary-color);">Articles référencés</p>
                    </div>
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);">
                        <i class="fas fa-boxes text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card card-hover rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Stock Bas</p>
                        <p class="text-3xl font-bold text-red-600">0</p>
                        <p class="text-sm text-red-600 mt-1">Attention requise</p>
                    </div>
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);">
                        <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card card-hover rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Demandes en Cours</p>
                        <p class="text-3xl font-bold text-yellow-600">0</p>
                        <p class="text-sm text-yellow-600 mt-1">0 en attente</p>
                    </div>
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);">
                        <i class="fas fa-shopping-cart text-white text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card card-hover rounded-2xl p-6 fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Valeur Stock</p>
                        <p class="text-3xl font-bold text-gray-900">0,00 MAD</p>
                        <p class="text-sm text-green-600 mt-1">Inventaire total</p>
                    </div>
                    <div class="w-14 h-14 rounded-2xl flex items-center justify-center shadow-lg" style="background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);">
                        <i class="fas fa-chart-line text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section with Mica Effects -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
            <!-- Stock Evolution Chart -->
            <div class="relative rounded-xl overflow-hidden mica-container">
                <div class="absolute inset-0 bg-white/90 backdrop-blur-lg border border-white/20"></div>
                <div class="relative z-10 p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Évolution du Stock</h3>
                        <p class="text-sm text-gray-600">Depuis les 4 derniers mois</p>
                    </div>
                    <div class="h-64">
                        <canvas id="stock-evolution-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Purchase Status Chart -->
            <div class="relative rounded-xl overflow-hidden mica-container">
                <div class="absolute inset-0 bg-white/90 backdrop-blur-lg border border-white/20"></div>
                <div class="relative z-10 p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Statut des Demandes</h3>
                        <p class="text-sm text-gray-600">Répartition des statuts d'achat</p>
                    </div>
                    <div class="h-64">
                        <canvas id="purchase-status-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="mb-8">
            <div class="relative rounded-xl overflow-hidden mica-container">
                <div class="absolute inset-0 bg-white/90 backdrop-blur-lg border border-white/20"></div>
                <div class="relative z-10 p-6">
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">Activité Récente</h3>
                        <p class="text-sm text-gray-600">Derniers mouvements de stock</p>
                    </div>
                    <div class="h-64" id="recent-movements">
                        <!-- Content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions & Stock Alerts -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 mb-8">
            <!-- Quick Actions -->
            <div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-900">Actions Rapides</h3>
                    </div>
                    <div class="p-6 space-y-3">
                        <a href="/articles" class="block">
                            <div class="w-full border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-sm flex items-center justify-center mr-3" style="background-color: rgba(0, 61, 157, 0.1);">
                                        <i class="fas fa-plus text-sm" style="color: var(--primary-color);"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Ajouter Article</p>
                                        <p class="text-xs text-gray-600">Nouveau produit</p>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <a href="/purchase-requests" class="block">
                            <div class="w-full border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-amber-50 rounded-sm flex items-center justify-center mr-3">
                                        <i class="fas fa-shopping-cart text-yellow-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Demande Achat</p>
                                        <p class="text-xs text-gray-600">Nouvelle demande</p>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <a href="/reception" class="block">
                            <div class="w-full border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-50 rounded-sm flex items-center justify-center mr-3">
                                        <i class="fas fa-truck text-green-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Réception</p>
                                        <p class="text-xs text-gray-600">Enregistrer livraison</p>
                                    </div>
                                </div>
                            </div>
                        </a>

                        <a href="/analytics" class="block">
                            <div class="w-full border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors duration-200">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-purple-50 rounded-sm flex items-center justify-center mr-3">
                                        <i class="fas fa-file-alt text-purple-600 text-sm"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Rapports</p>
                                        <p class="text-xs text-gray-600">Export données</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stock Alerts -->
            <div class="xl:col-span-2">
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900">Alertes Stock Bas</h3>
                            <span id="low-stock-badge" class="hidden bg-red-600 text-white text-xs px-2 py-1 rounded-sm"></span>
                        </div>
                    </div>
                    <div class="p-0" id="stock-alerts-content">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 bg-green-50 rounded-sm mx-auto mb-4 flex items-center justify-center">
                                <i class="fas fa-chart-line text-green-600 text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 mb-2">Aucune alerte stock</h4>
                            <p class="text-gray-600">Tous vos articles sont en stock suffisant</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let stockEvolutionChart, purchaseStatusChart;
    
    // Load dashboard data
    async function loadDashboardData() {
        try {
            // Load stats
            const stats = await apiRequest('GET', '/api/dashboard/stats');
            updateStatsCards(stats);
            
            // Update charts with real data from database
            updateCharts(stats);
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }

    function updateStatsCards(stats) {
        // Update individual cards with real data from database
        const cards = document.querySelectorAll('#stats-cards > div');
        
        // Total Articles Card
        if (cards[0]) {
            const valueElement = cards[0].querySelector('.text-3xl');
            if (valueElement) valueElement.textContent = stats.totalArticles || 0;
        }
        
        // Low Stock Card  
        if (cards[1]) {
            const valueElement = cards[1].querySelector('.text-3xl');
            if (valueElement) valueElement.textContent = stats.lowStock || 0;
        }
        
        // Pending Requests Card
        if (cards[2]) {
            const valueElement = cards[2].querySelector('.text-3xl');
            const statusElement = cards[2].querySelector('.text-yellow-600');
            if (valueElement) valueElement.textContent = stats.pendingRequests || 0;
            if (statusElement) statusElement.textContent = `${stats.pendingRequests || 0} en attente`;
        }
        
        // Stock Value Card
        if (cards[3]) {
            const valueElement = cards[3].querySelector('.text-3xl');
            const subtitleElement = cards[3].querySelector('.text-sm.mt-1');
            const stockValue = stats.stockValue || 0;
            
            if (valueElement) valueElement.textContent = formatCurrency(stockValue);
            
            // Add full number display below for large values
            if (subtitleElement && stockValue >= 100000) {
                const fullNumber = new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'MAD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(stockValue);
                subtitleElement.innerHTML = `Inventaire total<br><span class="text-xs text-gray-500">${fullNumber}</span>`;
            }
        }
    }

    function updateCharts(stats) {
        // Stock Evolution Chart - Simple month view with current data
        const stockCtx = document.getElementById('stock-evolution-chart').getContext('2d');
        stockEvolutionChart = new Chart(stockCtx, {
            type: 'line',
            data: {
                labels: ['Articles Total', 'Stock Bas', 'Stock OK'],
                datasets: [{
                    label: 'Répartition Stock',
                    data: [stats.totalArticles || 0, stats.lowStock || 0, (stats.totalArticles || 0) - (stats.lowStock || 0)],
                    borderColor: 'var(--primary-color)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Purchase Status Chart - Real data from database
        const statusCounts = stats.statusCounts || {};
        const statusLabels = [];
        const statusData = [];
        const statusColors = [];
        
        if (statusCounts.en_attente > 0) {
            statusLabels.push('En Attente');
            statusData.push(statusCounts.en_attente);
            statusColors.push('#F59E0B');
        }
        if (statusCounts.approuve > 0) {
            statusLabels.push('Approuvé');
            statusData.push(statusCounts.approuve);
            statusColors.push('#10B981');
        }
        if (statusCounts.commande > 0) {
            statusLabels.push('Commandé');
            statusData.push(statusCounts.commande);
            statusColors.push('var(--primary-color)');
        }
        if (statusCounts.recu > 0) {
            statusLabels.push('Reçu');
            statusData.push(statusCounts.recu);
            statusColors.push('#8B5CF6');
        }
        if (statusCounts.refuse > 0) {
            statusLabels.push('Refusé');
            statusData.push(statusCounts.refuse);
            statusColors.push('#EF4444');
        }
        
        // If no data, show empty state
        if (statusData.length === 0) {
            statusLabels.push('Aucune demande');
            statusData.push(1);
            statusColors.push('#E5E7EB');
        }

        const purchaseCtx = document.getElementById('purchase-status-chart').getContext('2d');
        purchaseStatusChart = new Chart(purchaseCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusData,
                    backgroundColor: statusColors,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function formatCurrency(value) {
        // Format large numbers with K or M suffixes
        if (value >= 1000000) {
            const millions = value / 1000000;
            return millions.toFixed(1) + 'M MAD';
        } else if (value >= 100000) { // 6 digits (100,000+)
            const thousands = value / 1000;
            return thousands.toFixed(0) + 'K MAD';
        } else {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'MAD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
    }

    // Button click handlers
    function createNewRequest() {
        window.location.href = '/purchase-requests';
    }

    function generateReport() {
        window.location.href = '/reports';
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}